<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>P2P Chat</title>
    </head>
    <body>
        <h1>P2P Chat (WebRTC + WebSocket Signaling)</h1>

        <label>Your ID: <input id="myId" /></label>
        <button onclick="join()">Join</button>
        <br><br>

        <label>Peer ID: <input id="peerId" /></label>
        <button onclick="connectToPeer()">Connect</button>
        <br><br>

        <div id="chat" style="border:1px solid #333; padding:10px; width:300px; height:200px; overflow:auto;"></div>
        <input id="msgBox" placeholder="Type message..." />
        <button onclick="sendMessage()">Send</button>

        <script>
            let ws;
            let pc;
            let dataChannel;
            let myId;
            let peerId;

            function log(msg) {
                const chat = document.getElementById("chat");
                chat.innerHTML += msg + "<br>";
                chat.scrollTop = chat.scrollHeight;
            }

            function join() {
                myId = document.getElementById("myId").value;
                ws = new WebSocket("ws://localhost:8080");

                ws.onopen = () => {
                    ws.send(JSON.stringify({ type: "join", id: myId }));
                    log("Joined signaling server as " + myId);
                };

                ws.onmessage = async (event) => {
                    const msg = JSON.parse(event.data);
                    if (msg.type === "signal") {
                        if (msg.payload.sdp) {
                            // Got SDP offer or answer
                            await pc.setRemoteDescription(new RTCSessionDescription(msg.payload));
                            if (msg.payload.type === "offer") {
                                const answer = await pc.createAnswer();
                                await pc.setLocalDescription(answer);
                                ws.send(JSON.stringify({
                                    type: "signal",
                                    target: msg.from,
                                    payload: answer
                                }));
                            }
                        } else if (msg.payload.candidate) {
                            // Got ICE candidate
                            try {
                                await pc.addIceCandidate(msg.payload);
                            } catch (err) {
                                console.error("Error adding candidate", err);
                            }
                        }
                    }
                };
            }

            async function connectToPeer() {
                peerId = document.getElementById("peerId").value;
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: "stun:stun.l.google.com:19302" }] // free STUN
                });

                // Data channel for chat
                dataChannel = pc.createDataChannel("chat");
                dataChannel.onmessage = (e) => log("Peer: " + e.data);

                // Handle ICE candidates
                pc.onicecandidate = (e) => {
                    if (e.candidate) {
                        ws.send(JSON.stringify({
                            type: "signal",
                            target: peerId,
                            payload: e.candidate
                        }));
                    }
                };

                // If remote peer creates channel
                pc.ondatachannel = (e) => {
                    dataChannel = e.channel;
                    dataChannel.onmessage = (ev) => log("Peer: " + ev.data);
                };

                // Create offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                ws.send(JSON.stringify({
                    type: "signal",
                    target: peerId,
                    payload: offer
                }));

                log("Connecting to " + peerId + "...");
            }

            function sendMessage() {
                const msg = document.getElementById("msgBox").value;
                if (dataChannel && dataChannel.readyState === "open") {
                    dataChannel.send(msg);
                    log("Me: " + msg);
                    document.getElementById("msgBox").value = "";
                } else {
                    log("Channel not ready");
                }
            }
        </script>
    </body>
</html>

